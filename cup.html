<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IVI Sprinter Cup</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    .cup-wrap {
      display: grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 1rem;
    }
    .cup-card {
      background: rgba(20,36,58,0.98);
      border: 1px solid rgba(0,122,51,0.2);
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .cup-head {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: .5rem;
      margin-bottom: .25rem;
    }
    .cup-title {
      margin: 0 0 .25rem;
      font-size: 1.2rem;
      color: #fff;
    }
    .cup-date {
      color: var(--text-light);
      font-size: .85rem;
      font-weight: 600;
    }
    .cup-sub {
      margin: 0 0 .85rem;
      text-align: center;
      color: var(--text-light);
      font-size: .9rem;
    }
    .cup-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: .8rem;
    }
    .cup-col-title {
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: .72rem;
      color: var(--text-light);
      text-align: center;
      margin-bottom: .5rem;
    }
    .cup-col {
      display: flex;
      flex-direction: column;
      gap: .7rem;
    }
    .cup-col-final {
      margin-top: 1.2rem;
    }
    .cup-match {
      background: #0b1f34;
      border: 1px solid rgba(0,122,51,0.25);
      border-radius: 12px;
      padding: .65rem;
    }
    .cup-team {
      display: flex;
      justify-content: space-between;
      gap: .4rem;
      font-weight: 700;
      font-size: .95rem;
    }
    .seed {
      color: var(--text-light);
      font-size: .78rem;
      font-weight: 600;
      margin-left: .35rem;
    }
    .cup-note {
      margin-top: .45rem;
      color: var(--text-light);
      font-size: .78rem;
      text-align: center;
    }
    @media (max-width: 900px) {
      .cup-wrap { grid-template-columns: 1fr; }
      .cup-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand">
      <img src="logo.png" alt="IVI" class="logo" />
      <h1>IVI Sprinter Cup</h1>
    </div>
    <nav class="nav">
      <a href="index.html#standings">Standings</a>
      <a href="index.html#fixtures">Fixtures</a>
      <a href="index.html">Back to League</a>
    </nav>
  </header>

  <main class="container">
    <h2 class="section-title">Cup Brackets</h2>
    <div id="cupWrap" class="cup-wrap"></div>
    <p class="note">Brackets are generated from the current league table. Top 4: Cup of Champions. Seeds 5-8: Conference Cup.</p>
  </main>

  <script>
    const MATCHES_CSV_URL = "matches.csv";
    const VALID_TEAMS = [
      "Caramel Dogs",
      "Rolling Thunder",
      "G/G",
      "MSVC Rats",
      "Fireball",
      "Nata",
      "Next Level",
      "MSVC Beavers"
    ];

    async function fetchCSV(url) {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      const rows = text.trim().split(/\r?\n/).map(l => l.split(","));
      const headers = rows[0].map(h => h.trim());
      return rows.slice(1)
        .filter(r => r.some(cell => String(cell || "").trim()))
        .map(r => Object.fromEntries(headers.map((h, i) => [h, (r[i] || "").trim()])));
    }

    function toNum(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function computeStandings(matches) {
      const byTeam = {};
      VALID_TEAMS.forEach(name => {
        byTeam[name] = { team: name, gp: 0, w: 0, l: 0, pts: 0, sets_w: 0, sets_l: 0, pf: 0, pa: 0 };
      });

      matches
        .filter(m => m.status === "played" || m.status === "final")
        .forEach(m => {
          const homeIsValid = VALID_TEAMS.includes(m.home_team);
          const awayIsValid = VALID_TEAMS.includes(m.away_team);
          if (!homeIsValid && !awayIsValid) return;

          let hs = 0, as = 0, hp = 0, ap = 0;
          [[m.set1_h, m.set1_a], [m.set2_h, m.set2_a], [m.set3_h, m.set3_a], [m.set4_h, m.set4_a], [m.set5_h, m.set5_a]]
            .forEach(([h, a]) => {
              if (h == null || a == null) return;
              if (h === 0 && a === 0) return;
              if (h > a) hs++; else if (a > h) as++;
              hp += h; ap += a;
            });

          if (homeIsValid) {
            const H = byTeam[m.home_team];
            H.gp++; H.sets_w += hs; H.sets_l += as; H.pf += hp; H.pa += ap;
          }
          if (awayIsValid) {
            const A = byTeam[m.away_team];
            A.gp++; A.sets_w += as; A.sets_l += hs; A.pf += ap; A.pa += hp;
          }

          if (hs > as && hs >= 3) {
            if (homeIsValid) { byTeam[m.home_team].w++; byTeam[m.home_team].pts += (as === 0 ? 3 : 2); }
            if (awayIsValid) { byTeam[m.away_team].l++; byTeam[m.away_team].pts += (as === 0 ? 0 : 1); }
          } else if (as > hs && as >= 3) {
            if (awayIsValid) { byTeam[m.away_team].w++; byTeam[m.away_team].pts += (hs === 0 ? 3 : 2); }
            if (homeIsValid) { byTeam[m.home_team].l++; byTeam[m.home_team].pts += (hs === 0 ? 0 : 1); }
          }
        });

      const rows = Object.values(byTeam).map(team => ({
        ...team,
        set_ratio: team.sets_l ? team.sets_w / team.sets_l : (team.sets_w ? team.sets_w : 0),
        points_ratio: team.pa ? team.pf / team.pa : (team.pf ? team.pf : 0)
      }));
      rows.sort((a, b) =>
        b.pts - a.pts ||
        b.set_ratio - a.set_ratio ||
        b.points_ratio - a.points_ratio ||
        a.team.localeCompare(b.team)
      );
      return rows;
    }

    function matchCard(a, b, label) {
      return `
        <div class="cup-match">
          <div class="cup-team"><span>${a.team}<span class="seed">#${a.seed}</span></span></div>
          <div class="cup-team"><span>${b.team}<span class="seed">#${b.seed}</span></span></div>
          <div class="cup-note">${label}</div>
        </div>
      `;
    }

    function placeholderCard(a, b, label) {
      return `
        <div class="cup-match">
          <div class="cup-team"><span>${a}</span></div>
          <div class="cup-team"><span>${b}</span></div>
          <div class="cup-note">${label}</div>
        </div>
      `;
    }

    function renderCup(container, title, seeds) {
      const [s1, s2, s3, s4] = seeds;
      container.innerHTML += `
        <section class="cup-card">
          <div class="cup-head">
            <h3 class="cup-title">${title}</h3>
            <span class="cup-date">26/04/2026</span>
          </div>
          <p class="cup-sub">${s1.seed} vs ${s4.seed} and ${s2.seed} vs ${s3.seed}</p>
          <div class="cup-grid">
            <div class="cup-col">
              <div class="cup-col-title">Semifinals</div>
              ${matchCard(s1, s4, "SF1")}
              ${matchCard(s2, s3, "SF2")}
            </div>
            <div class="cup-col">
              <div class="cup-col-title">3rd Place</div>
              ${placeholderCard("Loser SF1", "Loser SF2", "3rd Place")}
            </div>
            <div class="cup-col cup-col-final">
              <div class="cup-col-title">Final</div>
              ${placeholderCard("Winner SF1", "Winner SF2", "1st Place")}
            </div>
          </div>
        </section>
      `;
    }

    (async function initCup() {
      const raw = await fetchCSV(MATCHES_CSV_URL);
      const matches = raw.map(m => ({
        home_team: m.home_team,
        away_team: m.away_team,
        set1_h: toNum(m.set1_h), set1_a: toNum(m.set1_a),
        set2_h: toNum(m.set2_h), set2_a: toNum(m.set2_a),
        set3_h: toNum(m.set3_h), set3_a: toNum(m.set3_a),
        set4_h: toNum(m.set4_h), set4_a: toNum(m.set4_a),
        set5_h: toNum(m.set5_h), set5_a: toNum(m.set5_a),
        status: (m.status || "scheduled").toLowerCase()
      }));
      const standings = computeStandings(matches).map((row, idx) => ({ team: row.team, seed: idx + 1 }));
      const top4 = standings.slice(0, 4);
      const next4 = standings.slice(4, 8);
      const wrap = document.getElementById("cupWrap");
      if (top4.length < 4 || next4.length < 4) {
        wrap.innerHTML = '<div class="card">Not enough standings data to build Cup brackets yet.</div>';
        return;
      }
      renderCup(wrap, "Cup of Champions", top4);
      renderCup(wrap, "Conference Cup", next4);
    })();
  </script>
</body>
</html>
